---
title: 'AWS Lambda + MediaConvertë¡œ ë™ì˜ìƒ ì¸ì½”ë”© ë° ì¸ë„¤ì¼ ì¶”ì¶œí•˜ê¸°'
description: ì„¤ëª…
slug: encoding-with-lambda
date: 2023-08-31
excerpt: ë™ì˜ìƒ ì¸ì½”ë”© ë° ì¸ë„¤ì¼ ì¶”ì¶œ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•í•˜ê¸°
tags:
  - Typescript
  - AWS
  - Backend
published: true
---

![alt text](https://d2quahb2ygxiv.cloudfront.net/cf80faba38501bbbd7251.png?width=800&height=500)

ì´ê¸€ì—ì„  Serverless Frameworkì˜ Typescript í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ì—¬ S3ì˜ videos/ í´ë”ì˜ ì—…ë¡œë“œë¥¼ ê°ì§€í•˜ê³ 
ì¸ë„¤ì¼ ì¶”ì¶œê³¼ 3ê°€ì§€ í•´ìƒë„ë¡œ ì¸ì½”ë”©í•˜ì—¬ S3ì— ì €ì¥í•˜ëŠ” íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•˜ëŠ” ê³¼ì •ì„ ë‹¤ë£¬ë‹¤.

[ì´ì „ê¸€ ì°¸ê³  - serverless + typescriptë¥¼ ì‚¬ìš©í•˜ì—¬ AWS Lambda ë°°í¬í•˜ê¸°](deploy-lambda-using-serverless)

## ğŸ“š ì•ì„œì„œ

### AWS MideaConvert

ë¯¸ë””ì–´ íŒŒì¼ì˜ ë³€í™˜ê³¼ ì²˜ë¦¬ë¥¼ ê°„í¸í•˜ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” AWS ì„œë¹„ìŠ¤ì´ë‹¤.  
ë‹¤ì–‘í•œ í¬ë§·ìœ¼ë¡œ ë³€í™˜ê°€ëŠ¥í•˜ë©° ì ì‘í˜• ë¹„íŠ¸ë ˆì´íŠ¸ ìŠ¤íŠ¸ë¦¬ë°ì„ ì§€ì›í•˜ëŠ” í¬ë§·(MPEG-DASH, Apple HLS, Microsoft Smooth Streaming, CMAF)ì˜ ê²½ìš° DRM ì•”í˜¸í™”ë¥¼ ì§€ì›í•œë‹¤.

### DRM(Digital Rights Management)

ë””ì§€í„¸ ì»¨í…ì¸ ì˜ ì €ì‘ê¶Œì„ ë³´í˜¸í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ê¸°ìˆ ì´ë‹¤.
ì•”í˜¸í™”ë¡œ ë¬´ë‹¨ë³µì œ, ì¬ë°°í¬, ìˆ˜ì •ì„ ë°©ì§€í•˜ê³  ë¼ì´ì„¼ìŠ¤ë¥¼ ë°œê¸‰í•˜ì—¬ í—ˆìš© ëœ ì‚¬ìš©ìë§Œ ì»¨í…ì¸ ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì œí•œí•  ìˆ˜ ìˆìœ¼ë©°  
ì£¼ë¡œ ì €ì‘ê¶Œì´ ì¤‘ìš”í•œ ë™ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë°, ìŒì•… ìŠ¤íŠ¸ë¦¬ë°, ì „ìì„œì (E-book) ë“±ì— DRMê¸°ìˆ ì´ ì‚¬ìš©ëœë‹¤.

í•˜ì§€ë§Œ í•™ìŠµëª©ì ìœ¼ë¡œ DRMì„ ì ìš©í•˜ê¸°ì—” ë‹¤ì–‘í•œ ì œì•½ì‚¬í•­ì´ ìˆë‹¤.

ì˜ˆë¥¼ë“¤ì–´ Appleì˜ Fairplayë‚˜ Googleì˜ Widevine ê°™ì€ ìƒìš© DRM ì†”ë£¨ì…˜ë“¤ì€ íšŒì‚¬ì™€ ê³„ì•½ì„ í•˜ì—¬ ë¼ì´ì„¼ì‹± ì ˆì°¨ë¥¼ ê±°ì³ì•¼ ë¼ì´ì„¼ìŠ¤ ì„œë²„ê°€ ë°œê¸‰ëœë‹¤.

ë”°ë¼ì„œ ê°œì¸ì´ DRMì„ ì ìš©í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ê¸°ì—” ë¬´ë¦¬ê°€ ìˆìœ¼ë©° DRMì„ ì ìš©í•˜ë ¤ë©´ ë²•ë¥  ë° ê¸°ìˆ  ìš”ê±´ ë•Œë¬¸ì— ì „ë¬¸ê°€ì˜ ì¡°ì–¸ì„ ë°›ëŠ”ê²Œ ì¤‘ìš”í•˜ë‹¤.

## MediaConvert ì‘ì—… í…œí”Œë¦¿ ìƒì„±í•˜ê¸°

Lambdaì—ì„œ MediaConvertë¥¼ ì—°ê²°í•˜ì—¬ ì‘ì—…ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ì•¼í•œë‹¤.

### 1. ì´ë¦„ ì„¤ì •

![alt text](https://d2quahb2ygxiv.cloudfront.net/f80faba38501bbbd7251c.png?width=800&height=500)

### 2. ì…ë ¥ ì¶”ê°€

ì¶”ê°€ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë”°ë¡œ ê±´ë“¤ê±´ ì—†ë‹¤.

![alt text](https://d2quahb2ygxiv.cloudfront.net/80faba38501bbbd7251cf.png?width=800&height=500)

### 3. ì¶œë ¥ ê·¸ë£¹ ì¶”ê°€ (ì¸ì½”ë”©)

ì¶”ê°€ ë²„íŠ¼ -> íŒŒì¼ ê·¸ë£¹ ì„ íƒ

![alt text](https://d2quahb2ygxiv.cloudfront.net/0faba38501bbbd7251cfa.png?width=800&height=500)

ì™¼ìª½ H.264, AAC ì„ íƒ -> ì»¨í…Œì´ë„ˆ ë° ì´ë¦„ í•œì •ì ì„¤ì •

![alt text](https://d2quahb2ygxiv.cloudfront.net/faba38501bbbd7251cfa2.png?width=800&height=500)

ì•„ë˜ QVBR í’ˆì§ˆ ìˆ˜ì¤€ê³¼ ìµœëŒ€ ë¹„íŠ¸ìœ¨ì„ ì°¸ê³ í•˜ì—¬ ì„¤ì •

[QVBR ì°¸ê³ ](https://docs.aws.amazon.com/ko_kr/mediaconvert/latest/ug/cbr-vbr-qvbr.html)

![alt text](https://d2quahb2ygxiv.cloudfront.net/aba38501bbbd7251cfa2d.png?width=800&height=500)

ìœ„ ë°©ë²•ìœ¼ë¡œ 480p, 360p ì¶”ê°€

![alt text](https://d2quahb2ygxiv.cloudfront.net/ba38501bbbd7251cfa2d8.png?width=800&height=500)

### 4. ì¶œë ¥ ê·¸ë£¹ ì¶”ê°€ (ì¸ë„¤ì¼)

- 1. ìœ„ë¥¼ ì°¸ê³ í•˜ì—¬ íŒŒì¼ ê·¸ë£¹ ì¶”ê°€
- 2. ì»¨í…Œì´ë„ˆ ì—†ìŒ, í™•ì¥ jpg, ì´ë¦„ í•œì •ì(ì„ íƒ)
- 3. ì½”ë± JPEGë¡œ í”„ë ˆì„ ìº¡ì³, í¬ê¸° ì„¤ì •, ìµœëŒ€ ìº¡ì³ 1, ìŠ¤ì¼€ì¼ë§ ì¶œë ¥ ëŠ˜ë¦¬ê¸°

![alt text](https://d2quahb2ygxiv.cloudfront.net/a38501bbbd7251cfa2d88.png?width=800&height=500)

- 4. ì˜¤ë””ì˜¤ ì œê±°

![alt text](https://d2quahb2ygxiv.cloudfront.net/38501bbbd7251cfa2d885.png?width=800&height=500)

- 5. ìƒì„±

MediaConvert -> ì‘ì—… í…œí”Œë¦¿ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![alt text](https://d2quahb2ygxiv.cloudfront.net/8501bbbd7251cfa2d8853.png?width=800&height=500)

## Serverless Frameworkë¡œ lambda í•¨ìˆ˜ ì¶”ê°€

### 1. í™˜ê²½ë³€ìˆ˜ ì¶”ê°€

**serverless.ts**

```ts
...
  provider: {
    name: 'aws',
    runtime: 'nodejs14.x',
    apiGateway: {
      minimumCompressionSize: 1024,
      shouldStartNameWithService: true,
    },
    environment: {
      AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
      NODE_OPTIONS: '--enable-source-maps --stack-trace-limit=1000',
      ENDPOINT_MEDIA_CONVERT: '${param:ENDPOINT_MEDIA_CONVERT}',
      MEDIA_CONVERT_IAM_ROLE: '${param:MEDIA_CONVERT_IAM_ROLE}',
      // ë°°í¬ì‹œ ì•„ë˜ ëª…ë ¹ì–´ë¡œ í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
      // serverless deploy --param="ENDPOINT_MEDIA_CONVERT=í™˜ê²½ë³€ìˆ˜" --param="MEDIA_CONVERT_IAM_ROLE=í™˜ê²½ë³€ìˆ˜"
    },
  },
```

- ENDPOINT_MEDIA_CONVERT
  - mediaConvert -> ê³„ì •
- MEDIA_CONVERT_IAM_ROLE
  - IAM -> ì—­í•  -> `(lambda ì´ë¦„)-(ë‹¨ê³„)-(ë¦¬ì „)-lambdaRole ì„ íƒ` ì„ íƒ -> ARN

### 2. Lambda í•¨ìˆ˜ ì¶”ê°€

ì´ì „ ê²Œì‹œê¸€ì—ì„œ í…œí”Œë¦¿ì„ ì‚´í´ë³¸ëŒ€ë¡œ functions/helloë¥¼ ì°¸ê³ í•˜ì—¬ í•¨ìˆ˜ ì¶”ê°€

**functions/encodingAndThumbnail/index.ts**

s3 ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° ë“±ë¡ (S3 Bucket/videos/ í´ë”ì— íŒŒì¼ì´ ìƒì„±ë ë•Œ)

[ì°¸ê³ ](https://www.serverless.com/framework/docs/providers/aws/events/s3)

```ts
import { handlerPath } from '@libs/handler-resolver';

export default {
  handler: `${handlerPath(__dirname)}/handler.encodingAndThumbail`,
  events: [
    {
      s3: {
        bucket: 'ìƒì„± í•  S3 Bucket ì´ë¦„',
        event: 's3:ObjectCreated:*',
        rules: [{ prefix: 'videos/' }],
      },
    },
  ],
};
```

**functions/encodingAndThumbnail/handler.ts**

```ts
import * as AWS from 'aws-sdk';
import { S3Event } from 'aws-lambda';
import middy from '@middy/core';

// MediaConvert ê°ì²´ ìƒì„±
const mediaconvert = new AWS.MediaConvert({
  endpoint: process.env.ENDPOINT_MEDIA_CONVERT,
});

// íƒ€ì… ì°¸ê³  https://docs.aws.amazon.com/lambda/latest/dg/typescript-handler.html
const handler = async (event: S3Event) => {
  for (const record of event.Records) {
    const bucketName = record.s3.bucket.name;
    const objectKey = decodeURIComponent(
      record.s3.object.key.replace(/\+/g, ' ')
    );

    // ì¸í’‹ íŒŒì¼
    const inputLocation = `s3://${bucketName}/${objectKey}`;

    // ì•„ì›ƒí’‹ í´ë” ìœ„ì¹˜
    const thumbnailOutputLocation = `s3://${bucketName}/thumbnails/`;
    const videoOutputLocation = `s3://${bucketName}/encodedVideos/`;

    const params = {
      JobTemplate: 'encodingAndThumbnailTemplate', // ìƒì„±í•œ mediaConvert í…œí”Œë¦¿ ì´ë¦„
      Role: process.env.MEDIA_CONVERT_IAM_ROLE,
      Settings: {
        Inputs: [
          {
            FileInput: inputLocation,
          },
        ],
        OutputGroups: [
          // ì¸ì½”ë”© íŒŒì¼ ê·¸ë£¹ ì¶œë ¥ ì„¸íŒ…
          {
            Name: 'File Group - encodedVideos', // í…œí”Œë¦¿ì— ì„¤ì •ëœ íŒŒì¼ê·¸ë£¹ëª…ê³¼ ë™ì¼í•´ì•¼í•¨
            Outputs: [
              {
                Extension: 'mp4',
              },
            ],
            OutputGroupSettings: {
              Type: 'FILE_GROUP_SETTINGS',
              FileGroupSettings: {
                Destination: `${videoOutputLocation}`, // ì•„ì›ƒí’‹ ìœ„ì¹˜
              },
            },
          },
          // ì¸ë„¤ì¼ íŒŒì¼ ê·¸ë£¹ ì¶œë ¥ ì„¸íŒ…
          {
            Name: 'File Group - thumbnail', // í…œí”Œë¦¿ì— ì„¤ì •ëœ íŒŒì¼ê·¸ë£¹ëª…ê³¼ ë™ì¼í•´ì•¼í•¨
            Outputs: [
              {
                Extension: 'jpg',
              },
            ],
            OutputGroupSettings: {
              Type: 'FILE_GROUP_SETTINGS',
              FileGroupSettings: {
                Destination: `${thumbnailOutputLocation}`,
              },
            },
          },
        ],
      },
    };

    try {
      let data = await mediaconvert.createJob(params).promise();

      // ì™„ë£Œ ì‹œ ì¶”ê°€ ì‘ì—…ì´ ìˆë‹¤ë©´ ì¶”ê°€(ë©”ì¼ì•Œë¦¼ ë“±)
      console.log(`Job created! ID is ${data.Job.Id}`);
    } catch (error) {
      console.error(`Failed to start job for object "${objectKey}": ${error}`);
    }
    return {};
  }
};

// middy ì°¸ê³  https://middy.js.org/docs/events/s3
export const encodingAndThumbail = middy()
  .use(eventNormalizerMiddleware())
  .handler(handler);
```

**functions/index.ts**

```ts
export { default as hello } from './hello'; // (default)
export { default as encodingAndThumbail } from './encodingAndThumbnail';
```

**serverless.ts**

í•¨ìˆ˜ ì¶”ê°€

```ts
import encodingAndThumbail from '@functions/encodingAndThumbail';

 ...
  functions: {
    encodingAndThumbail,
  },

```

## Lambda ë°°í¬

ì•„ë˜ ëª…ë ¹ì–´ë¡œ ë°°í¬
(ì•„ì§ IAM Roleì´ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ í™˜ê²½ë³€ìˆ˜ë¥¼ ì§€ìš°ê³  serverless deployë¡œ ë°°í¬í•˜ë©´ IAM ìƒì„±ë¨)

```cs
$ serverless deploy --param="ENDPOINT_MEDIA_CONVERT=í™˜ê²½ë³€ìˆ˜" --param="MEDIA_CONVERT_IAM_ROLE=í™˜ê²½ë³€ìˆ˜"
```

ë°°í¬ ì™„ë£Œ ì‹œ AWSì— serverlessì—ì„œ ì‚¬ìš©í•˜ëŠ” S3 ë²„í‚·, ì´ë²¤íŠ¸ê°€ ë“±ë¡ëœ S3 ë²„í‚·, Lambda ì–´í”Œë¦¬ì¼€ì´ì…˜ ë° í•¨ìˆ˜, CloudFormationì´ ìƒì„±ëœë‹¤.

## ìƒì„±ëœ IAM Roleì— ì¶”ê°€ ê¶Œí•œ ì„¤ì •

ì´ì œ ë°°í¬ëœ Lambda í•¨ìˆ˜ê°€ ì‘ì—…ì„ í•˜ê¸°ìœ„í•´ì„œ í•„ìš”í•œ ê¶Œí•œì„ ì„¤ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.

ê¶Œí•œ ì¶”ê°€í•˜ëŠ” ë²•
IAM -> ì—­í•  -> "(lambda ì´ë¦„)-(ë‹¨ê³„)-(ë¦¬ì „)-lambdaRole ì„ íƒ" -> ê¶Œí•œ ì¶”ê°€ -> ì¸ë¼ì¸ ì •ì±… ìƒì„± -> JSON ì„ íƒ

### 1. S3ì˜ Bucket ê¶Œí•œ ì¶”ê°€

[ì°¸ê³ ]("https://repost.aws/ko/knowledge-center/s3-console-access-certain-bucket")

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:ListBucket"],
      "Resource": ["arn:aws:s3:::woo3145-test"]
    },
    {
      "Effect": "Allow",
      "Action": ["s3:GetObject", "s3:PutObject"],
      "Resource": ["arn:aws:s3:::woo3145-test/*"]
    }
  ]
}
```

### 2. MediaConvertì˜ ì‘ì—…ì„ ìƒì„±í•˜ëŠ” ê¶Œí•œ ì¶”ê°€

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["mediaconvert:CreateJob"],
      "Resource": "*"
    }
  ]
}
```

### 3. iam:PassRole ì¶”ê°€

iam:PassRole: Lambdaê°€ ê°€ì§„ ê¶Œí•œë“¤ì„ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— ì „ë‹¬í•´ì¤„ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤.

í˜„ì¬ ìƒí™©ì„ ì˜ˆë¡œë“¤ë©´ Lambda í•¨ìˆ˜ ì´ì™¸ì—ë„ MediaConvertê°€ S3ì— ì ‘ê·¼í•˜ëŠ” ê¶Œí•œì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— Lambdaê°€ ê°€ì§„ S3ì ‘ê·¼ ê¶Œí•œì„ iam:PassRoleì„ í†µí•´ MediaConvertì— ì „ë‹¬í•´ì¤Œìœ¼ë¡œì¨ MediaConvertê°€ S3ì—ì„œ íŒŒì¼ì„ ê°€ì ¸ì˜¤ê³ , ì €ì¥í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ê²ƒì´ë‹¤.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["iam:PassRole"],
      "Resource": "*"
    }
  ]
}
```

### 4. ì‹ ë¢° ê´€ê³„ ìˆ˜ì •

ì‹ ë¢° ê´€ê³„ íƒ­ -> ì‹ ë¢° ì •ì±… í¸ì§‘

```ts
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": [
                    "mediaconvert.amazonaws.com",
                    "lambda.amazonaws.com"
                ]
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

ì™„ë£Œëœ ëª¨ìŠµ

![alt text](https://d2quahb2ygxiv.cloudfront.net/501bbbd7251cfa2d88532.png?width=800&height=500)

## ë§ˆë¬´ë¦¬

ì´ì œ ìƒì„±ëœ S3ì— videos í´ë”ë¥¼ ìƒì„±í•˜ê³  sample-1.mp4, sample-2.mp4ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì •ìƒì ìœ¼ë¡œ ì¸ë„¤ì¼ ìƒì„± ë° ì¸ì½”ë”©ì´ ì™„ë£Œëœë‹¤.

![alt text](https://d2quahb2ygxiv.cloudfront.net/01bbbd7251cfa2d88532d.png?width=800&height=500)

![alt text](https://d2quahb2ygxiv.cloudfront.net/1bbbd7251cfa2d88532d3.png?width=800&height=500)

ì¶”ê°€ë¡œ í•´ë‹¹ S3ë²„í‚·ì„ CDN ì„œë¹„ìŠ¤(AWS CloudFront)ë¥¼ ì‚¬ìš©í•´ ë°°í¬í•˜ë©´ ë„¤íŠ¸ì›Œí¬ì— ìºì‹±í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ í–¥ìƒë˜ê³  ë¹„ìš©ì„ ì ˆê°í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— S3ë²„í‚·ì„ ë°”ë¡œ ì‚¬ìš©í•˜ì§€ ë§ê³  CloudFrontì— ë°°í¬í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.
