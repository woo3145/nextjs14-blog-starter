---
title: 'NestJS ê¶Œí•œë³„ë¡œ ì‘ë‹µ ê°ì²´ ì§ë ¬í™” (Serialization) í•˜ê¸°'
description: ì„¤ëª…
slug: nest-serialization
date: 2024-02-19
excerpt: ë„ë©”ì¸ ê°ì²´ í•˜ë‚˜ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ ì‘ë‹µë³„ ê°ì²´ í•„ë“œ ë‹¤ë¥´ê²Œ ë³´ì—¬ì£¼ê¸°(ìœ ì €, ë³¸ì¸, ì–´ë“œë¯¼)
tags:
  - NestJS
  - Backend
published: true
---

ë°±ì—”ë“œëŠ” ìš”ì²­ì˜ ìµœì¢… ì‘ë‹µì„ í•˜ê¸°ì „ì— ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ì œì™¸í•˜ê±°ë‚˜ íŠ¹ì • ì‚¬ìš©ì(ì–´ë“œë¯¼, ë³¸ì¸) ë³„ë¡œ ì‘ë‹µì„ ë‹¬ë¦¬ ì£¼ì–´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ë¹„ì¼ë¹„ì¬ í•©ë‹ˆë‹¤.

ì´ ì‘ì—…ì€ ì‘ë‹µ ê°ì²´ë§ˆë‹¤ `dto`ë¥¼ ì§ì ‘ ë§¤í•‘í•˜ì—¬ í•´ê²° í•  ìˆ˜ ìˆì§€ë§Œ í•˜ë‚˜í•˜ë‚˜ ë§¤í•‘ í•˜ë‹¤ë³´ë©´ ì‹¤ìˆ˜í•  ì—¬ì§€ë„ í¬ê³  ëˆˆì´ ì •ë§ ì•„í”„ê¸° ë•Œë¬¸ì— ğŸ˜µ
ì´ë²ˆ ê²Œì‹œê¸€ì—ì„œ `domain` ê°ì²´ì™€ `mapper`ë¥¼ ë§Œë“¤ì–´ `domain` ê°ì²´ì—ì„œ í•œë²ˆì— í†µì œí•  ìˆ˜ ìˆë„ë¡ ë§Œë“œëŠ” ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

## ì§ë ¬í™”(Serialization) ?

ì§ë ¬í™”(Serialization)ëŠ” ë°ì´í„° êµ¬ì¡°ë‚˜ ê°ì²´ ìƒíƒœë¥¼ ì €ì¥, ì „ì†¡ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
ë³´í†µ ê°ì²´ë¥¼ JSONí˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ë©° NodeJSëŠ” `class-transformer`ë¥¼ í†µí•´ ì§ë ¬í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
ì§ë ¬í™”ëœ ë°ì´í„°ëŠ” ë‚˜ì¤‘ì— ì—­ì§ë ¬í™”(Deserialization) ê³¼ì •ì„ ê±°ì³ ì›ë˜ì˜ ë°ì´í„° êµ¬ì¡°ë‚˜ ê°ì²´ ìƒíƒœë¡œ ë³µì›ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

nestjsì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ `class-transformer`ì˜ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

- `classToPlain` - ê°ì²´ë¥¼ ì¼ë°˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¡œ ì§ë ¬í™” í•©ë‹ˆë‹¤.
- `plainToClass` - ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¥¼ íŠ¹ì • í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

## NestJS ì„¤ì •

NestJSì—ì„œëŠ” ì¸í„°ì…‰í„°ë¥¼ í†µí•´ ìë™ìœ¼ë¡œ `classToPlain`ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
yarn add reflect-metadata class-transformer
```

- `reflect-metadata`

  í´ë˜ìŠ¤ì™€ ê°ì²´ì— ë©”íƒ€ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ê³ , ì‹¤í–‰ ì‹œê°„ì— ì´ ë©”íƒ€ë°ì´í„°ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ
  ì£¼ë¡œ TypeScriptì™€ í•¨ê»˜ ì‚¬ìš©ë˜ì–´, ë°ì½”ë ˆì´í„°ë¥¼ í†µí•œ ë©”íƒ€í”„ë¡œê·¸ë˜ë°ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

main.ts

```ts
app.useGlobalInterceptors(new ClassSerializerInterceptor(app.get(Reflector)));
```

## Domain Object

```ts
import { Exclude, Expose } from 'class-transformer';

export class User {
  id: number;

  name: string;

  @Expose({ groups: ['me', 'admin'] })
  email: string | null;

  @Exclude({ toPlainOnly: true })
  password?: string;

  @Expose({ groups: ['me', 'admin'] })
  provider: string;

  @Expose({ groups: ['me', 'admin'] })
  socialId?: string | null;

  @Expose({ groups: ['admin'] })
  createdAt: Date;
}
```

- `@Exclude()`
  ì§ë ¬í™” í• ë•Œ ì œì™¸í•  í•„ë“œë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

  `toPlainOnly` ì˜µì…˜ì€ í•´ë‹¹ í•„ë“œê°€ ì§ë ¬í™” ë ë•Œë§Œ ì œì™¸í•˜ë„ë¡ í•©ë‹ˆë‹¤. (ê¸€ë¡œë²Œ ì¸í„°ì…‰í„°ì—ì„œ `classToPlain`)
  ë§Œì•½ í•´ë‹¹ ì˜µì…˜ì´ ì—†ë‹¤ë©´ ì—­ì§ë ¬í™” í• ë•Œë„ í•„ë“œê°€ ì œì™¸ë©ë‹ˆë‹¤. (ë°˜ëŒ€ ì˜µì…˜ - `toClassOnly`)

- `@Expose()`
  ì§ë ¬í™” ëŒ€ìƒ í•„ë“œë¡œ í¬í•¨í•©ë‹ˆë‹¤.
  groups ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ í•´ë‹¹ ê·¸ë£¹ìœ¼ë¡œ ì§€ì •ëœ `Controller`ìš”ì²­ì—ë§Œ í¬í•¨í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ì•„ë¬´ê²ƒë„ ë¶™ì´ì§€ ì•Šìœ¼ë©´ ë””í´íŠ¸ë¡œ `@Expose()`ë¡œ ì²˜ë¦¬ë˜ì§€ë§Œ ê¸€ë¡œë²Œ ì¸í„°ì…‰í„°ì˜ ì„¤ì •ì„ í†µí•´ ë™ì‘ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ```ts
  app.useGlobalInterceptors(
    new ClassSerializerInterceptor(app.get(Reflector), {
      strategy: 'excludeAll', // "exposeAll" | "excludeAll"
    })
  );
  ```

## Mapper

Entityì™€ ë„ë©”ì¸ ê°ì²´ë¥¼ ë§¤í•‘í•˜ëŠ” Mapperë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
ë§Œì•½ Entityë¥¼ ë„ë©”ì¸ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œë‹¤ë©´ Entityì— ì§ì ‘ `@Exclude()`ë‚˜ `@Expose()`ë¥¼ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.

users/repository/mapper/user.mapper.ts

```ts
export class UserMapper {
  static toDomain(raw: UserEntity): User {
    const user = new User();
    user.id = raw.id;
    user.email = raw.email;
    user.password = raw.password;
    user.provider = raw.provider;
    user.socialId = raw.socialId;
    user.createdAt = raw.createdAt;
    return user;
  }
}
```

## Service

ë„ë©”ì¸ ê°ì²´ë¡œ ë§¤í•‘í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤. í•´ë‹¹ ì‘ì—…ì€ Repository ê³„ì¸µì„ ë§Œë“¤ì–´ ì²˜ë¦¬í•´ë„ ë©ë‹ˆë‹¤.

```ts
const user = await this.repository.findOne(id);
return user ? UserMapper.toDomain(user) : null;
```

## Controller

- `@SerializeOptions()` - í•´ë‹¹ ì˜µì…˜ì„ í†µí•´ Interceptorì—ì„œ ê°€ë¡œì±„ê¸° ì „ì— ì§ë ¬í™” ì˜µì…˜ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts
@SerializeOptions({
  groups: ['admin'],
})
@Get('admin/users/:id')
findOne(@Param('id') id: User['id']): Promise<NullableType<User>> {
  return this.usersService.findOne({ id });
}

// Response
// {
//   id: 1,
//   name: "Woo",
//   provider: "Email"
//   socialId: null,
//   createdAt: "xxxx-xx-xx"
// }
```

```ts
@Get('users/:id')
findOne(@Request() request): Promise<NullableType<User>> {
  return this.usersService.findOne({ id });
}

// Response
// {
//   id: 1,
//   name: "Woo"
// }
```

```ts
@SerializeOptions({
  groups: ['me'],
})
@UseGuards(AuthGuard('jwt'))
@Get('auth/me')
findOne(@Request() request): Promise<NullableType<User>> {
  return this.authService.getMe(request.user);
}

// Response
// {
//   id: 1,
//   name: "Woo",
//   provider: "Email"
//   socialId: null,
// }
```

## ê²°ë¡ 

ë§¤ë²ˆ ì‘ë‹µë³„ë¡œ `dto`ë¥¼ ë§Œë“¤ì–´ ë§¤í•‘í•˜ëŠ” ê²ƒ ë³´ë‹¤ `class-transformer`ë¥¼ ì˜ í™œìš©í•˜ë©´ ì‘ë‹µì„ ê´€ë¦¬í•˜ê¸° ë§¤ìš° ìˆ˜ì›”í•´ì§„ë‹¤.

ì´ë²ˆ ê¸€ì—ì„  `me`,`admin` ë‘ ê°€ì§€ë¡œ ì˜ˆì‹œë¥¼ ë“¤ì—ˆì§€ë§Œ ì¢€ë” `groups`ê°€ ë§ì•„ì§€ë©´ `domain` íŒŒì¼ í•˜ë‚˜ì—ì„œ ëª¨ë“  ì‘ë‹µì„ í¸í•˜ê²Œ ì œì–´í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

ì¶”ê°€ë¡œ `class-validator`ì™€ `class-transformer`ë¡œ ìš”ì²­ì„ dtoë¡œ ì—­ì§ë ¬í™” í•˜ëŠ”ê±´ ê³µì‹ë¬¸ì„œì— ë” ì˜ ë‚˜ì™€ìˆê¸° ë•Œë¬¸ì— íŒ¨ìŠ¤

[NestJS ê³µì‹ë¬¸ì„œ](https://docs.nestjs.com/techniques/validation#auto-validation)
