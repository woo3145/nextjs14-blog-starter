---
title: 'ë½€ëª¨ë‹­ ê°œë°œê¸° 5í¸ - NestJS ìœ ì§€ë³´ìˆ˜ì™€ í™•ì¥ì„±ì— ëŒ€í•œ ë°±ì—”ë“œ ì´ì•¼ê¸°(2)'
description: Nest í”„ë¡œì íŠ¸ ì•„í‚¤í…ì³ ì •ë¦¬, Env ì„¤ì •, DB ë§ˆì´ê·¸ë ˆì´ì…˜, Seeds ê´€ë¦¬ ë“± ì‰¬ìš´ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•œ ì´ˆê¸° ì„¤ì •
date: '2024-04-25'
image: 'https://d2quahb2ygxiv.cloudfront.net/2b83116c6013071489283.png'
authors:
  - woo3145
tags:
  - ğŸ¥Pomodak
  - Project
  - Backend
published: true
---

ì•ˆë…•í•˜ì„¸ìš”. ìµœê·¼ ì¼ì£¼ì¼ ë„˜ê²Œ ìŒí–¥ì¼ì´ ë°”ë¹ ì„œ ê¸€ ì‘ì„±ì´ ëŠ¦ì–´ì§€ë„¤ìš”.

ì–´ì œ í”ŒëŸ¬í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë§ˆë¬´ë¦¬ ì§“ê³  ë°°í¬ë¥¼ ì§„í–‰í•´ì„œ, ì´ì œ ë°±ì—”ë“œ ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ë ¤ê³  í•©ë‹ˆë‹¤.

ë¬´ì—‡ì„ ì‘ì„±í• ì§€ ê³ ë¯¼í•˜ë‹¤ê°€, `NestJS` í”„ë¡œì íŠ¸ì˜ ì•„í‚¤í…ì³ë¥¼ ì •ë¦¬í•˜ê³ , DB ê´€ë¦¬, CI/CD ì„¤ì • ë“±ì„ ë‹¤ë£¨ì–´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.

í”ŒëŸ¬í„°ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•˜ë©´ì„œ ë°±ì—”ë“œì˜ ì—­í• ì„ í”„ë¡ íŠ¸ë¡œ ë§ì´ ì˜®ê²¼ê¸° ë•Œë¬¸ì—, fcmì´ë‚˜ íƒ€ì´ë¨¸ ë¡œì§ë“¤ì€ ê°„ëµí•˜ê²Œ ì‘ì„±í•˜ê³ , `NestJS` ìì²´ì— ì¢€ë” ì§‘ì¤‘í•´ì„œ ì¶”í›„ `NestJS`ë¡œ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

BullMQë‚˜ FCM, Redis, OAuth, Socket ë“± ë½€ëª¨ë‹­ì— ì ìš©ëœ ë‹¤ì–‘í•œ ê¸°ìˆ ë“¤ë„ ë‹¤ë£¨ê³  ì‹¶ì€ë° í”ŒëŸ¬í„° í¸ë„ ì‘ì„±í•´ì•¼í•˜ê³  ê°œë°œê¸°ê°€ ë„ˆë¬´ ê¸¸ì–´ì ¸ì„œ ì¶”í›„ ë‹¨ë… í¬ìŠ¤íŒ…ë“¤ë¡œ ì¢€ë” ìì„¸íˆ ë‹¤ë£¨ê³  ë°±ì—”ë“œëŠ” 6í¸ì—ì„œ ë§ˆë¬´ë¦¬ ì§“ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

## NestJS ì—­í• 

ë½€ëª¨ë‹­ì—ì„œ `NestJS`ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

- ì¸ì¦
- FCM í‘¸ì‹œì•Œë¦¼
- ~~íƒ€ì´ë¨¸, í†µê³„~~
- DB ê´€ë¦¬
- ë©”ì¼ ë°œì†¡
- ì—…ë¡œë“œ
- ê°ì¢… ì¡°íšŒ API

íƒ€ì´ë¨¸, í†µê³„ ê¸°ëŠ¥ì€ í”ŒëŸ¬í„°ë¡œ ì˜®ê²¨ì„œ ë”ì´ìƒ Nestì—ì„  ë”ì´ìƒ ì—…ë°ì´íŠ¸ë¥¼ í•˜ì§€ ì•Šê³ , PWAë¥¼ ìœ„í•´ ìœ ì§€ë³´ìˆ˜ë§Œ ì§„í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤.

## ëª©ì°¨

ì´ë²ˆ ê¸€ì—ì„œ ë‹¤ë£° ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- ì•„í‚¤í…ì³
- env ì„¤ì •
- DB ê´€ë¦¬
- seeds ê´€ë¦¬ (ì´ˆê¸°ë°ì´í„° ì‘ì—…, ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ì† ì‘ì—…)
- ~~CI/CD (ë‹¤ìŒ ê¸€)~~
- ~~Testing (ë‹¤ìŒ ê¸€)~~

## ê°„ëµí•œ ì•„í‚¤í…ì³

ë¨¼ì € ê°„ëµí•˜ê²Œ NestJS í”„ë¡œì íŠ¸ êµ¬ì¡°ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

í¬ê³  ëŒ€ê·œëª¨ì¸ í”„ë¡œì íŠ¸ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì—, í´ë¦° ì•„í‚¤í…ì³ë‚˜ DDDë¥¼ ì ìš©í•˜ì§€ ì•Šê³  ê¸°ë³¸ì ìœ¼ë¡œ ê³µì‹ë¬¸ì„œì—ì„œ ì œê³µí•˜ëŠ” êµ¬ì¡°ë¥¼ ë”°ë¼ê°€ê³ , `Spring`ì„œë²„ì™€ ì›í• í•œ í˜‘ì—…ì„ ìœ„í•´ Domain Modelì— ëŒ€í•œ ë¶„ë¦¬ë§Œ ì§„í–‰í•˜ì˜€ìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ 1í¸ì—ì„œ ì†Œê°œí–ˆë‹¤ì‹œí”¼ ê¸°ì¡´ì— `Hororok`ì´ë¼ëŠ” í”„ë¡œì íŠ¸ì—ì„œ ëª¨ë…¸ë ˆí¬ êµ¬ì„±ìœ¼ë¡œ `Pomodak`ì„ ì¶”ê°€í•´ì„œ ì‘ì—…í•˜ë‹¤ê°€ `Pomodak`ìœ¼ë¡œ ì„œë²„ë¥¼ í†µí•©í•˜ëŠ” ê³¼ì •ì´ ìˆì—ˆìŠµë‹ˆë‹¤.

ì´ì—ë”°ë¼ `MongoDB`ë¥¼ ì‚¬ìš©í•˜ë˜ `Hororok`ì„œë²„ì—ì„œ MySQLë¡œ í†µí•©í•˜ë©´ì„œ DBë§Œ ëŠìŠ¨í•œ ê²°í•©ì„ í†µí•´ ë³€ê²½í•˜ê¸° ìˆ˜ì›”í•˜ë„ë¡ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.

ê°„ë‹¨í•˜ê²Œ í•˜ë‚˜ì˜ ëª¨ë“ˆì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```bash
./apps/timer-app
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ notification
â”‚   â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”‚   â”œâ”€â”€ notification-config.ts
â”‚   â”‚   â”‚   â””â”€â”€ notification-config.type.ts
â”‚   â”‚   â”œâ”€â”€ dtos
â”‚   â”‚   â”‚   â”œâ”€â”€ create-notification-token.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ update-notification-token.dto.ts
â”‚   â”‚   â”œâ”€â”€ notification.controller.ts
â”‚   â”‚   â”œâ”€â”€ notification.module.ts
â”‚   â”‚   â”œâ”€â”€ notification.service.ts
â”‚   â”‚   â””â”€â”€ repositories
â”‚   â”‚       â”œâ”€â”€ notification-token.repository.interface.ts
â”‚   â”‚       â””â”€â”€ typeorm
â”‚   â”‚           â””â”€â”€ notification-token.repository.ts
```

- `config`: ëª¨ë“ˆì— í•„ìš”í•œ ENV ì„¤ì •ì„ ì •ì˜
- `dtos`: API ìš”ì²­, ì‘ë‹µ ë“±ì— ì‚¬ìš©ë˜ëŠ” DTOë¥¼ ì •ì˜(Validation Pipeë¥¼ í†µí•´ ìœ íš¨ì„± ê²€ì¦)
- `controller`: API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì •ì˜í•˜ê³ , Parmasë¥¼ ì ì ˆí•œ DTOë¡œ ë³€í™˜í•˜ì—¬ Serviceì— ì „ë‹¬
- `module`: ëª¨ë“ˆì„ ì •ì˜í•˜ê³ , NestJSì˜ ëª¨ë“ˆì„ importí•˜ì—¬ ì‚¬ìš©
- `service`: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•˜ê³ , Repositoryë¥¼ í†µí•´ DBì— ì ‘ê·¼
- `repositories`: DBì— ì ‘ê·¼í•˜ëŠ” Repositoryë¥¼ ì •ì˜í•˜ê³ , í•˜ìœ„ í´ë”ì— ORMì„ ì‚¬ìš©í•˜ëŠ” Repositoryë¥¼ ì •ì˜

ìœ„ ëª¨ë“ˆì€ `Notification` ëª¨ë“ˆë¡œ, FCM í‘¸ì‹œì•Œë¦¼ì„ ìœ„í•œ ëª¨ë“ˆì…ë‹ˆë‹¤. ìœ„ êµ¬ì„± ì´ì™¸ì—ë„ `guards`, `decorators`, `interceptors` ë“± í•„ìš”ì— ë”°ë¼ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.

## Env êµ¬ì„±

ê°€ì¥ ë¨¼ì € Env êµ¬ì„±ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

Env êµ¬ì„±ì€ ê° ëª¨ë“ˆì˜ `config` í´ë”ì— `module-config.ts`ì™€ `module-config.type.ts`ë¡œ êµ¬ì„±ë˜ì–´ ìˆê³  `module-config.ts`ì—ì„œ `validate-config.ts`ë¼ëŠ” ìœ í‹¸ë¦¬í‹° íŒŒì¼ì„ í†µí•´ ë¹Œë“œì „ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ì—¬ env ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆë‹¤ë©´ ë¹Œë“œë¥¼ ì¤‘ë‹¨í•˜ë„ë¡ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

```bash

src
â”œâ”€â”€ notification
â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”œâ”€â”€ notification-config.ts
â”‚   â”‚   â””â”€â”€ notification-config.type.ts
â”œâ”€â”€ database
â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”œâ”€â”€ database-config.ts
â”‚   â”‚   â””â”€â”€ database-config.type.ts
â”œâ”€â”€ redis
â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”œâ”€â”€ redis-config.ts
â”‚   â”‚   â””â”€â”€ redis-config.type.ts
â”œâ”€â”€ upload
â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”œâ”€â”€ upload-config.ts
â”‚   â”‚   â””â”€â”€ upload-config.type.ts
â”œâ”€â”€ config
â”‚   â”œâ”€â”€ app-config.ts
â”‚   â”œâ”€â”€ app-config.type.ts
â”‚   â””â”€â”€ config.type.ts            // ëª¨ë“  ëª¨ë“ˆì˜ config typeì„ í†µí•©
â”œâ”€â”€ utils
â”‚   â””â”€â”€ validate-config.ts
```

### validate-config.ts

ë¨¼ì € `validate-config.ts`ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

í•´ë‹¹ íŒŒì¼ì€ ì˜ˆì „ì— í¬ìŠ¤íŒ…í•œ Serializationì— ëŒ€í•œ ê¸€ì—ì„œ ë‹¤ë£¨ì—ˆë˜ `class-transformer`ì™€ `class-validator`ë¥¼ ì‚¬ìš©í•˜ì—¬ env ì„¤ì •ì„ ìœ íš¨ì„± ê²€ì‚¬í•©ë‹ˆë‹¤.

```typescript
import { plainToClass } from 'class-transformer';
import { validateSync } from 'class-validator';
import { ClassConstructor } from 'class-transformer/types/interfaces';

export const validateConfig = <T extends object>(
  config: Record<string, unknown>,
  envVariablesClass: ClassConstructor<T>
) => {
  const validatedConfig = plainToClass(envVariablesClass, config, {
    enableImplicitConversion: true, // íƒ€ì… ìë™ ë³€í™˜ í—ˆìš©
  });
  const errors = validateSync(validatedConfig, {
    skipMissingProperties: false, // í”„ë¡œí¼í‹°ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ë¡œ ì¡ìŒ
  });

  if (errors.length > 0) {
    throw new Error(errors.toString());
  }
  return validatedConfig;
};
```

- plainToClass - ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¥¼ íŠ¹ì • í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
- validateSync - í•´ë‹¹ ê°ì²´ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•©ë‹ˆë‹¤.

í•´ë‹¹ ìœ í‹¸ì˜ ì‚¬ìš©ë²•ì€ ë‹¤ìŒ íŒŒì¼ë“¤ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### redis/config/redis-config.type.ts

Envê°€ ë‘ê°œë§Œ ì¡´ì¬í•˜ëŠ” ê°„ë‹¨í•œ ëª¨ë“ˆë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

í•´ë‹¹ íŒŒì¼ì€ ëª¨ë“ˆì´ ì‚¬ìš©í•  Envì˜ íƒ€ì…ì„ ì •ì˜í•©ë‹ˆë‹¤.

```typescript
export type RedisConfig = {
  host: string;
  port: number;
};
```

### redis/config/redis-config.ts

validatorë¥¼ ì •ì˜í•˜ê³ , registerAsë¥¼ í†µí•´ í•´ë‹¹ ëª¨ë“ˆì˜ configë¥¼ ë“±ë¡í•˜ë©´ì„œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```typescript
import { registerAs } from '@nestjs/config';
import { IsInt, IsOptional, IsString, Min } from 'class-validator';

import { validateConfig } from '../../utils/validate-config';
import { RedisConfig } from './redis-config.type';

export class RedisEnvironmentVariablesValidator {
  @IsString()
  REDIS_HOST: string;

  @IsInt()
  @Min(1)
  @IsOptional()
  REDIS_PORT: number;
}

export default registerAs<RedisConfig>('redis', () => {
  validateConfig(process.env, RedisEnvironmentVariablesValidator);

  return {
    host: process.env.REDIS_HOST || 'localhost',
    port: process.env.REDIS_PORT ? parseInt(process.env.REDIS_PORT, 10) : 6379,
  };
});
```

- `registerAs` - í•´ë‹¹ ëª¨ë“ˆì˜ configë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
- `validateConfig` - ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

  process.envëŠ” `Record<string, string>` í˜•íƒœë¡œ í˜„ì¬ ëŸ°íƒ€ì„ì˜ í™˜ê²½ë³€ìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. í•´ë‹¹ ê°ì²´ì™€ `Validator ê°ì²´`ë¥¼ ì „ë‹¬í•˜ë©´ `plainToClass`ë¥¼ í†µí•´ ê°ì²´ë¡œ ë³€í™˜í•˜ê³ , `validateSync`ë¥¼ í†µí•´ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰ í›„ ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì—ëŸ¬ë¥¼ ë˜ì ¸ ë¹Œë“œì— ì‹¤íŒ¨í•˜ë„ë¡ í•©ë‹ˆë‹¤.

### config/config.type.ts

ê° ëª¨ë“ˆì˜ config typeì„ í†µí•©í•˜ëŠ” íŒŒì¼ì…ë‹ˆë‹¤.

```typescript
import { GoogleConfig } from '../auth-google/config/auth-google-config.type';
import { KakaoConfig } from '../auth-kakao/config/auth-kakao-config.type';
import { NaverConfig } from '../auth-naver/config/auth-naver-config.type';
import { AuthConfig } from '../auth/config/auth-config.type';
import { DatabaseConfig } from '../database/config/database-config.type';
import { MailConfig } from '../mail/config/mail-config.type';
import { NotificationConfig } from '../notification/config/notification-config.type';
import { UploadConfig } from '../uploads/config/upload-config.type';
import { AppConfig } from './app-config.type';
import { RedisConfig } from '../redis/config/redis-config.type';

export type AllConfigType = {
  app: AppConfig;
  database: DatabaseConfig;
  auth: AuthConfig;
  redis: RedisConfig;
  google: GoogleConfig;
  kakao: KakaoConfig;
  naver: NaverConfig;
  upload: UploadConfig;
  notification: NotificationConfig;
  mail: MailConfig;
};
```

í•´ë‹¹ íƒ€ì…ì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì´ configServiceë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript
class AService {
  constructor(private configService: ConfigService<AllConfigType>) {}

  getRedisConfig() {
    return {
      host: this.configService.get('redis.host', { infer: true }),
      port: this.configService.get('redis.port', { infer: true }),
    };
  }
}
```

- infer: true - íƒ€ì… ì¶”ë¡ ì„ í†µí•´ íƒ€ì…ì„ ì¶”ë¡ í•©ë‹ˆë‹¤.

### app.module.ts

ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ, `ConfigModule.forRoot`ë¥¼ í†µí•´ env ì„¤ì •ì„ ë¡œë“œí•©ë‹ˆë‹¤.

```typescript
@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      load: [
        appConfig,
        databaseConfig,
        authConfig,
        redisConfig,
        googleConfig,
        kakaoConfig,
        naverConfig,
        uploadConfig,
        notificationConfig,
        mailConfig,
      ],
      envFilePath: [`.env.${process.env.NODE_ENV}`],
    }),
    // ...
  ],
})
export class TimerAppModule {}
```

ì´ ë°©ë²•ì„ í†µí•´ ê° ëª¨ë“ˆì˜ env ì„¤ì •ì„ í†µí•©í•˜ê³  ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í”„ë¡œì íŠ¸ì— í•œë²ˆ êµ¬ì„±í•´ë†“ìœ¼ë©´ í™•ì¥ë„ í¸í•˜ê³  Env ì„¤ì •ì´ ëˆ„ë½ë˜ë©´ ì‚¬ì „ì— ë¹Œë“œë¥¼ ì¤‘ë‹¨í•  ìˆ˜ ì•ˆì •ì ìœ¼ë¡œ ì„œë²„ë¥¼ ìš´ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ì¶”í›„ì— ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•  ë•Œë„ í•´ë‹¹ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.

## DB ê´€ë¦¬

### ê³µí†µ repositories êµ¬ì¡°

ë¨¼ì € database ëª¨ë“ˆì„ ì‚´í´ë³´ê¸° ì „ì— ê±°ì˜ ëª¨ë“  ëª¨ë“ˆì—ì„œ ì‚¬ìš©ì¤‘ì¸ repositories í´ë”ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ê° ëª¨ë“ˆì˜ repositoriesëŠ” ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

```bash
aModule
â”‚   â””â”€â”€ repositories
â”‚       â”œâ”€â”€ aaa.repository.interface.ts
â”‚       â””â”€â”€ typeorm
â”‚           â””â”€â”€ aaa.repository.ts
â”‚       â””â”€â”€ mongooese
â”‚           â””â”€â”€ aaa.repository.ts
â”‚       â””â”€â”€ prisma
â”‚           â””â”€â”€ aaa.repository.ts
â”‚       â””â”€â”€ mook
â”‚           â””â”€â”€ aaa.repository.ts
```

- `aaa.repository.interface.ts` - `Repository Interface`ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
- `typeorm` - `TypeORM`ì„ ì‚¬ìš©í•˜ëŠ” `Repository`ì˜ êµ¬í˜„ì²´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
- `mongoose` - `Mongoose`ë¥¼ ì‚¬ìš©í•˜ëŠ” `Repository`ì˜ êµ¬í˜„ì²´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

Nestì—ì„œ ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ORMì€ `TypeORM`, `Mongoose`, `Prisma` ë“±ì´ ìˆìŠµë‹ˆë‹¤.

ë½€ëª¨ë‹­ì—ì„œ `NoSQL`ì„ `MySQL`ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ë©´ì„œ `Mongoose`ë¥¼ ì‚¬ìš©í•˜ë˜ ëª¨ë“ˆì„ `TypeORM`ìœ¼ë¡œ ë³€ê²½í•˜ë©´ì„œ í•´ë‹¹ êµ¬ì¡°ë¥¼ ì ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

`TypeORM`ì„ ì‚¬ìš©í• ë•Œ ê° DBì˜ ì˜ì¡´ì„±ì„ ì œê±°í•˜ê³  `TypeORM`ì˜ Interfaceë¥¼ í†µí•´ ì—¬ëŸ¬ `RDBMS`ì— ëŒ€í•œ ì ‘ê·¼ì„ í•˜ë“¯,

`Repository Interface`ë¥¼ í†µí•´ `RDBMS`ë‚˜ `NoSQL`ì„ ì§€ì›í•˜ëŠ” ORMì— ëŒ€í•œ ì˜ì¡´ì„±ì„ ì œê±°í•˜ê³ , í•„ìš”í•œ `Repository`ë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë¡œì¸í•´ ORMì„ ë³€ê²½í• ë•Œ `repository.interface`ì˜ êµ¬í˜„ì²´ë§Œ ì¶”ê°€í•˜ê³ , `aaa.module.ts`ì—ì„œ ì˜ì¡´ì„±ë§Œ ë³€ê²½í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì— ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•´ì§‘ë‹ˆë‹¤.

ê° íŒŒì¼ë“¤ì„ ë”°ë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

#### item.module.ts

ì—¬ê¸°ì„œ `providers`ì— `ItemRepository`ì— ëŒ€í•´ ê° ORMì— ëŒ€í•œ êµ¬í˜„ì²´ë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { ItemsService } from './items.service';
import { ItemsController } from './items.controller';
import { ItemEntity } from '../database/entities/item.entity';
import { ItemRepository } from './repositories/item.repository.interface';
import { TypeOrmItemRepository } from './repositories/typeorm/item.repository';

@Module({
  imports: [TypeOrmModule.forFeature([ItemEntity])],
  controllers: [ItemsController],
  providers: [
    ItemsService,
    {
      provide: ItemRepository,
      useClass: TypeOrmItemRepository,
    },
  ],
})
export class ItemsModule {}
```

ë§Œì•½ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ `MockRepository` í˜¹ì€ `NoSQL`ì„ ì‚¬ìš©í•˜ëŠ” `MongooseRepository`ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´, í•´ë‹¹ êµ¬í˜„ì²´ë¥¼ ì¶”ê°€í•˜ê³ , `useClass`ë¥¼ ë³€ê²½í•˜ë©´ ë©ë‹ˆë‹¤.

ì™¸ë¶€ì—ì„  ì•„ë˜ì™€ ê°™ì´ `ItemRepository`ë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì™¸ë¶€ì—ì„œëŠ” ì–´ë–¤ ORMì„ ì‚¬ìš©í•˜ëŠ”ì§€ ì•Œ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

```typescript
@Injectable()
export class ItemsService {
  constructor(private readonly itemsRepository: ItemRepository) {}

  async getItems(queryRunner?: QueryRunner): Promise<Item[]> {
    return await this.itemsRepository.getItems(queryRunner);
  }
}
```

#### item.repository.interface.ts

DBì— ëŒ€í•œ í•„ìš”í•œ ë©”ì„œë“œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

ì €ëŠ” íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ê²½ìš° `QueryRunner`ë¥¼ ì „ë‹¬ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

```typescript
import { QueryRunner } from 'typeorm';
import { Item } from '../../database/domain/item';

export abstract class ItemRepository {
  abstract getItems(queryRunner?: QueryRunner): Promise<Item[]>;
}
```

#### typeorm/item.repository.ts

ê° ORMì— ëŒ€í•œ êµ¬í˜„ì²´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

ì´í›„ì— ë‚˜ì˜¤ëŠ” DB Domain ê°ì²´ì™€ Mapperë¥¼ í†µí•´ ê°ì²´ë¥¼ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì´ë¡œì¸í•´ ê° DBì—ì„œ í•„ë“œëª…ì´ ë‹¤ë¥´ê±°ë‚˜ êµ¬ì¡°ê°€ ë‹¤ë¥´ë”ë¼ë„ Domain ê°ì²´ë¡œ í†µí•©í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ `TypeORM`ì—ì„œ `QueryRunner`ì˜ ì—¬ë¶€ì— ë”°ë¼ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

```typescript
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { QueryRunner, Repository } from 'typeorm';
import { ItemRepository } from '../item.repository.interface';
import { ItemEntity } from 'apps/timer-app/src/database/entities/item.entity';
import { Item, ItemType } from 'apps/timer-app/src/database/domain/item';
import { ItemMapper } from 'apps/timer-app/src/database/mappers/item.mapper';

@Injectable()
export class TypeOrmItemRepository implements ItemRepository {
  constructor(
    @InjectRepository(ItemEntity)
    private itemRepository: Repository<ItemEntity>
  ) {}

  /** queryRunner ì—¬ë¶€ì— ë”°ë¼ item Repositoryë¥¼ ìƒì„± */
  private getRepository(queryRunner?: QueryRunner): Repository<ItemEntity> {
    return queryRunner
      ? queryRunner.manager.getRepository(ItemEntity)
      : this.itemRepository;
  }

  async getItems(queryRunner?: QueryRunner): Promise<Item[]> {
    const repository = this.getRepository(queryRunner);

    const entities = await repository.find({
      where: { is_hidden: false },
    });

    return entities.map((n) => ItemMapper.toDomain(n));
  }
}
```

### database ëª¨ë“ˆ êµ¬ì„±

`TypeORM`ì— ëŒ€í•œ ëª¨ë“ˆì´ë¼ ì›ë˜ ì´ë¦„ì´ `typeorm`ì´ ë˜ì–´ì•¼ í•˜ì§€ë§Œ, ê°€ì¥ ì¤‘ì¶•ì´ ë˜ëŠ” RDBMS ëª¨ë“ˆì´ê¸° ë•Œë¬¸ì— `database`ë¡œ ì´ë¦„ì„ ë³€ê²½í•˜ì˜€ìŠµë‹ˆë‹¤.

í•´ë‹¹ ëª¨ë“ˆì—ì„œ `RDBMS` ì—°ê²°, `Migration`, `Seed` ë“±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

ë˜í•œ `Spring`ì—ì„œ ë„ë©”ì¸ì„ ì‚¬ìš©í•˜ì§€ë§Œ `NestJS`ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ë©”ì¸ë“¤ì´ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— `repositories`ì—ì„œ `domain`, `mappers`, `entity`ë¥¼ ê´€ë¦¬í•˜ì§€ ì•Šê³  `database` ëª¨ë“ˆì—ì„œ ê´€ë¦¬í•˜ë„ë¡ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

ë§Œì•½ í•˜ë‚˜ì˜ ì„œë²„ì—ì„œë§Œ DBë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ê° ëª¨ë“ˆì—ì„œ ê´€ë¦¬í•´ë„ ë˜ì§€ë§Œ, ì—¬ëŸ¬ ì„œë²„ì—ì„œ ì‚¬ìš©í•˜ê±°ë‚˜, DBë¥¼ ë³€ê²½í•˜ê³  ê´€ë¦¬í•˜ëŠ” í™˜ê²½ì—ì„œëŠ” `database` ëª¨ë“ˆì—ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ìœ ì§€ë³´ìˆ˜ì— ìš©ì´í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

```bash
â”œâ”€â”€ database
â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”œâ”€â”€ database-config.ts
â”‚   â”‚   â””â”€â”€ database-config.type.ts
â”‚   â”œâ”€â”€ domain
â”‚   â”‚   â”œâ”€â”€ item.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ entities
â”‚   â”‚   â”œâ”€â”€ item.entity.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ mappers
â”‚   â”‚   â”œâ”€â”€ item.mapper.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ migrations
â”‚   â”‚   â”œâ”€â”€ 1710919691677-init.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ seeds
â”‚   â”‚   â”œâ”€â”€ roles
â”‚   â”‚   â”‚   â”œâ”€â”€ roles.seed.module.ts
â”‚   â”‚   â”‚   â””â”€â”€ roles.seed.service.ts
â”‚   â”‚   â”œâ”€â”€ run-seed.ts
â”‚   â”‚   â”œâ”€â”€ seed.ts
â”‚   â”‚   â”œâ”€â”€ seeds.module.ts
â”‚   â”‚   â””â”€â”€ temp
â”‚   â”‚       â”œâ”€â”€ member-character-collection-migrate.module.ts
â”‚   â”‚       â””â”€â”€ member-character-collection-migrate.service.ts
â”‚   â”œâ”€â”€ data-source.ts
â”‚   â””â”€â”€ typeorm-config.service.ts
```

ê°„ë‹¨í•˜ê²Œ ê° íŒŒì¼ì˜ ì—­í• ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

- `config`: ìœ„ì—ì„œ ì„¤ëª…í•œ DBì˜ ENV ì„¤ì •ì„ ì •ì˜í•©ë‹ˆë‹¤. (dbType, host, port, username, password ë“±ë“±)
- `domain`: DBì˜ Domain ê°ì²´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
- `entities`: TypeORMì˜ Entityë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
- `mappers`: Entity -> Domain í˜¹ì€ Domain -> Entityë¡œ ë³€í™˜í•˜ëŠ” Mapperë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
- `migrations`: DBì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ì •ì˜í•©ë‹ˆë‹¤. (ìë™ ìƒì„±)
- `seeds`: DBì˜ ì´ˆê¸° ë°ì´í„°ë¥¼ ì„¤ì •í•˜ëŠ” ëª¨ë“ˆ (run-seed.tsë¥¼ ì‹¤í–‰í•˜ë©´ ì´ˆê¸°ë°ì´í„°ë¥¼ ë„£ê³  ì¢…ë£Œ)
  - `temp`: ìƒˆ í…Œì´ë¸” ì¶”ê°€ë¡œì¸í•´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒˆ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ì•¼ í•  ê²½ìš° ìƒì„±í•˜ì—¬ run-seed.tsì—ì„œ ì‹¤í–‰
- `data-source.ts`: ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•  DB ì—°ê²°ì„ ì •ì˜í•©ë‹ˆë‹¤.
- `typeorm-config.service.ts`: TypeORMì˜ Configë¥¼ ì •ì˜í•©ë‹ˆë‹¤. (DBì™€ ì—°ê²°, Entity, Migration, Seed ë“±ë¡)

ê°€ì¥ ë¨¼ì € ë§ˆì´ê·¸ë ˆì´ì…˜ì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### DB ë§ˆì´ê·¸ë ˆì´ì…˜

ì—¬ëŸ¬ ì„œë²„ì—ì„œ í•˜ë‚˜ì˜ `DB`ë¥¼ ì‚¬ìš©í• ë•Œ ê° ì„œë²„ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•˜ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ê¼¬ì´ê²Œ ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ ë°˜ë“œì‹œ í•˜ë‚˜ì˜ ì„œë²„ì—ì„œë§Œ `DDL`ì„ ê´€ë¦¬í•˜ê³  ë‚˜ë¨¸ì§€ ì„œë²„ëŠ” DBì˜ DMLë§Œ ì‚¬ìš©í•˜ë„ë¡ í•´ì•¼í•©ë‹ˆë‹¤.

ì €ë²ˆ ê¸€ì—ì„œ ì„¤ëª…í–ˆë“¯ `Spring`ì˜ `JPA`ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í•˜ë©´ í•„ìˆ˜ì ì¸ `DDL`ë§Œ ì ìš©ë˜ê³  ìƒì„¸í•œ ì˜µì…˜ì€ ì‹¤ì œ DBì— ì ìš©ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— `Nest`ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•˜ëŠ”ê²Œ ìš©ì´í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ë°˜ë“œì‹œ ê° ì„œë²„ì—ì„œ `synchronize` ì˜µì…˜ì„ êº¼ì„œ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ë˜ì§€ ì•Šë„ë¡ ì„¤ì •í•´ì•¼í•©ë‹ˆë‹¤.

#### data-source.ts ì‘ì„±

ë¨¼ì € ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•  DB ì—°ê²°ì„ ì •ì˜í•©ë‹ˆë‹¤.

```typescript
import { DataSource, DataSourceOptions } from 'typeorm';

export const AppDataSource = new DataSource({
  type: process.env.DB_TYPE,
  host: process.env.DB_HOST,
  port: process.env.DB_PORT ? parseInt(process.env.DB_PORT, 10) : 3306,
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  synchronize: process.env.DB_SYNCHRONIZE === 'true',

  logging: process.env.NODE_ENV !== 'prod',
  entities: [__dirname + '/../**/*.entity{.ts,.js}'],
  migrations: [__dirname + '/migrations/**/*{.ts,.js}'],
} as DataSourceOptions);
```

#### package.jsonì— ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€

```json
{
  // ...
  "scripts": {
    "typeorm": "env-cmd -f .env.development ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js",
    "migration:generate": "yarn typeorm -- -d apps/timer-app/src/database/data-source.ts migration:generate apps/timer-app/src/database/migrations/{ë§ˆì´ê·¸ë ˆì´ì…˜ëª…}",
    "migration:create": "yarn typeorm -- migration:create",
    "migration:run": "yarn typeorm -- -d apps/timer-app/src/database/data-source.ts migration:run",
    "migration:revert": "yarn typeorm -- -d apps/timer-app/src/database/data-source.ts migration:revert"
  }
  // ...
}
```

[tsconfig-paths/register](https://www.npmjs.com/package/tsconfig-paths) : typeormì´ tsconfigì˜ pathsë¥¼ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •

- `migration:generate`: datasourceì™€ ë¹„êµí•˜ì—¬ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
- `migration:create`: ë¹ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
- `migration:run`: ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
- `migration:revert`: ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë˜ëŒë¦½ë‹ˆë‹¤.

### íë¦„

ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•  ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì€ íë¦„ì„ ë”°ë¦…ë‹ˆë‹¤.

1. `DB Entity`ì— ë³€ê²½ì‚¬í•­ì´ ìƒê¹€
2. `typeorm` ìŠ¤í¬ë¦½íŠ¸ì˜ envíŒŒì¼ì´ `.env.development`ì¸ì§€ ì²´í¬
3. ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•˜ê¸°ì „ `migration:generate` ìŠ¤í¬ë¦½íŠ¸ì˜ `{ë§ˆì´ê·¸ë ˆì´ì…˜ëª…}`ì„ ë³€ê²½ì‚¬í•­ì— ë§ê²Œ ì ì ˆí•˜ê²Œ ìˆ˜ì • (ex. description-column-to-item)
4. `yarn run migration:generate`ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ìƒì„±
   - `migrations/1710919691677-description-column-to-item.ts` ìƒì„±ë¨
5. `yarn run migration:run`ìœ¼ë¡œ ê°œë°œ DBì— ì ìš©
   - ë§Œì•½ ë¬¸ì œ ë°œìƒì‹œ `yarn run migration:revert`ë¡œ ë³µêµ¬ í›„ í•´ë‹¹ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì œê±°, ë¬¸ì œ í•´ê²° í›„ ë‹¤ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
6. í…ŒìŠ¤íŠ¸ í›„ `typeorm` ìŠ¤í¬ë¦½íŠ¸ì˜ `.env.development`ë¥¼ `.env.production`ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ `yarn run migration:run`ìœ¼ë¡œ ì‹¤ì œ ì„œë²„ DBì— ì ìš©

7. Springì—ê²Œ ë³€ê²½ì‚¬í•­ ì ìš©ì„ ì•Œë¦¼

## Seed íŒŒì¼ ê´€ë¦¬

`DB`ë¥¼ ê´€ë¦¬ í•  ë•Œ ì´ˆê¸° ë°ì´í„°ë¥¼ ë„£ì–´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•˜ëŠ” ê²½ìš° ê¸°ì¡´ ë°ì´í„°ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ë³€ê²½ì‚¬í•­ì— ë”°ë¥¸ ì¶”ê°€ ì‘ì—…ì´ í•„ìš”í•œ ê²½ìš°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

ì´ˆê¸° ë°ì´í„°ë¥¼ ë„£ê±°ë‚˜, ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì¶”ê°€ ì‘ì—…ì„ ì§„í–‰í•˜ê¸° ìœ„í•´ `database ëª¨ë“ˆ`ì— `seeds`ë¼ëŠ” í´ë”ë¥¼ ìƒì„±í•˜ì—¬ ê´€ë¦¬í•©ë‹ˆë‹¤.

### seeds.ts

`DB`ì— í•„ìš”í•œ ì´ˆê¸° ë°ì´í„°ë¥¼ ë„£ê¸° ìœ„í•œ íŒŒì¼ì…ë‹ˆë‹¤.

```typescript
import { RoleEnum } from 'apps/timer-app/src/roles/roles.enum';

export const RoleSeeds = [
  {
    id: RoleEnum.admin,
    name: 'Admin',
  },
  {
    id: RoleEnum.user,
    name: 'User',
  },
];
```

### seed.module.ts

ê° `ê°œë°œ ì„œë²„`, `í”„ë¡œë•ì…˜ ì„œë²„`ì— ëŒ€í•œ ì„¤ì •ì€ `envFilePath`ë¥¼ í†µí•´ ì„¤ì •í•˜ê³ , `TypeORM`ì˜ `DataSource`ë¥¼ í†µí•´ DB ì—°ê²°ì„ ì„¤ì •í•©ë‹ˆë‹¤.

ë£¨íŠ¸ ëª¨ë“ˆê³¼ ë‹¨ë…ìœ¼ë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ë£¨íŠ¸ ëª¨ë“ˆì²˜ëŸ¼ ì‹¤í–‰ì— í•„ìš”í•œ ëª¨ë“ˆì´ë‚˜ `config`ë¥¼ `import`í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { TypeOrmModule } from '@nestjs/typeorm';
import { DataSource, DataSourceOptions } from 'typeorm';

import { TypeOrmConfigService } from '../typeorm-config.service';
import databaseConfig from '../config/database-config';
import appConfig from '../../config/app.config';
import { RoleSeedModule } from './roles/roles.seed.module';
import { MemberCharacterCollectionMigrateModule } from './temp/member-character-collection-migrate.module';

@Module({
  imports: [
    RoleSeedModule,
    // MemberCharacterCollectionMigrateModule,
    ConfigModule.forRoot({
      isGlobal: true,
      load: [databaseConfig, appConfig],
      envFilePath: ['.env.prod'],
    }),
    TypeOrmModule.forRootAsync({
      useClass: TypeOrmConfigService,
      dataSourceFactory: async (options: DataSourceOptions) => {
        return new DataSource(options).initialize();
      },
    }),
  ],
})
export class SeedModule {}
```

### DB ì‘ì—… module, service ì‘ì„±

`run-seed.ts`ì—ì„œ ì‹¤í–‰ì‹œí‚¬ `module`, `service`ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ì´ˆê¸° ì‹œë“œ ë°ì´í„°ë¥¼ ë„£ê±°ë‚˜ ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì¶”ê°€ ì‘ì—…ì„ ì§„í–‰í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
// seeds/roles/seeds.module.ts
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { RoleSeedService } from './roles.seed.service';
import { RoleEntity } from 'apps/timer-app/src/database/entities/role.entity';

@Module({
  imports: [TypeOrmModule.forFeature([RoleEntity])],
  providers: [RoleSeedService],
  exports: [RoleSeedService],
})
export class RoleSeedModule {}
```

```typescript
// seeds/roles/roles.seed.service.ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { RoleEntity } from 'apps/timer-app/src/database/entities/role.entity';
import { Repository } from 'typeorm';
import { RoleSeeds } from '../seed';

@Injectable()
export class RoleSeedService {
  constructor(
    @InjectRepository(RoleEntity)
    private repository: Repository<RoleEntity>
  ) {}

  async run() {
    for (const role of RoleSeeds) {
      const exist = await this.repository.count({
        where: {
          role_id: role.id,
        },
      });

      if (!exist) {
        await this.repository.save(
          this.repository.create({
            role_id: role.id,
            name: role.name,
          })
        );
      }
    }
  }
}
```

ê° `service`ëŠ” `run ë©”ì„œë“œ`ë¥¼ í†µí•´ ì´ˆê¸° ë°ì´í„°ë¥¼ ë„£ê±°ë‚˜ ì¶”ê°€ ì‘ì—…ì„ ì§„í–‰í•©ë‹ˆë‹¤.

### run-seed.ts

DBì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰ì‹œí‚¬ íŒŒì¼ì…ë‹ˆë‹¤.

```typescript
import { NestFactory } from '@nestjs/core';
import { SeedModule } from './seeds.module';
import { RoleSeedService } from './roles/roles.seed.service';
import { AccountSeedService } from './accounts/accounts.seed.service';
import { MemberSeedService } from './members/members.seed.service';
import { MemberCharacterCollectionMigrateService } from './temp/member-character-collection-migrate.service';

// ì‹œë“œ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì™€ì„œ ê° ì„œë¹„ìŠ¤ run ì‹¤í–‰
const runSeed = async () => {
  const app = await NestFactory.create(SeedModule);

  // ì‹œë“œ íŒŒì¼ ì‹¤í–‰
  await app.get(RoleSeedService).run();
  // await app.get(AccountSeedService).run();

  // ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì¶”ê°€ ì‘ì—…
  await app.get(MemberCharacterCollectionMigrateService).run();

  await app.close();
};

void runSeed();
```

### package.jsonì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€

í”„ë¡œì íŠ¸ì˜ ê²½ë¡œì— ë§ê²Œ run-seed.ts ìœ„ì¹˜ë¥¼ ë³€ê²½í•˜ê³ , package.jsonì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```json
{
  // ...
  "scripts": {
    "seed:run": "ts-node -r tsconfig-paths/register ./apps/timer-app/src/database/seeds/run-seed.ts"
    // ...
  }
}
```

### íë¦„

Seed íŒŒì¼ì„ ì§„í–‰í•  ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì€ íë¦„ì„ ë”°ë¦…ë‹ˆë‹¤.

1. ì´ˆê¸°ë°ì´í„° ë° DB ì¶”ê°€ ì‘ì—…ì„ ìœ„í•œ Seed ëª¨ë“ˆ, ì„œë¹„ìŠ¤ ì‘ì„±
2. `seed.module.ts`ì— í•´ë‹¹ ëª¨ë“ˆ ì„í¬íŠ¸
3. `run-seed.ts`ì—ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ì½”ë“œ ì¶”ê°€
4. `seed.module.ts`ì˜ envFilePathì— ì‹œë“œë¥¼ ì‹¤í–‰í•  í™˜ê²½ í™•ì¸
5. `yarn run seed:run`ìœ¼ë¡œ ì‘ì—… ì‹¤í–‰

### ì£¼ì˜ì‚¬í•­

ì‹œë“œë¥¼ ì¶”ê°€í•  ë• íŠ¸ëœì ì…˜ ë¡¤ë°±ì´ë‚˜ ì ì ˆí•œ ì²˜ë¦¬ë¥¼ í†µí•´ ì¤‘ë³µëœ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì§€ ì•Šë„ë¡ í™•ì¸í•˜ê³  ë°˜ë“œì‹œ ê°œë°œ í™˜ê²½ì—ì„œ ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œ í›„ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì‹¤í–‰í•´ì•¼í•©ë‹ˆë‹¤.

ë‹¤ìŒê³¼ ì˜ˆì‹œì™€ ê°™ì´ ì ì ˆí•œ ë¡œê¹…ê³¼ ì¤‘ë³µë°ì´í„° ì²˜ë¦¬ë¥¼ í†µí•˜ì—¬ ì‘ì—…ì´ ì •ìƒì ìœ¼ë¡œ ì§„í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³ , ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ì¦‰ì‹œ ë³µêµ¬í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

ë˜í•œ ë°ì´í„°ëŸ‰ì´ ë§ì„ ê²½ìš° DBì— ë¶€í•˜ë¥¼ ì£¼ê¸° ë•Œë¬¸ì— ì ì ˆí•œ ì‹œê°„ì— ì‹¤í–‰í•˜ë„ë¡ í•©ë‹ˆë‹¤.

```typescript
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

import { MemberEntity } from '../../entities/member.entity';
import { CharacterInventoryEntity } from '../../entities/character-inventory.entity';
import { MemberCharacterCollectionEntity } from '../../entities/member-character-collection.entity';

@Injectable()
export class MemberCharacterCollectionMigrateService {
  constructor(
    @InjectRepository(MemberEntity)
    private memberRepository: Repository<MemberEntity>,
    @InjectRepository(CharacterInventoryEntity)
    private characterInventoryRepository: Repository<CharacterInventoryEntity>,
    @InjectRepository(MemberCharacterCollectionEntity)
    private collectionRepository: Repository<MemberCharacterCollectionEntity>
  ) {}

  async run() {
    let tasks = 0;
    let alreadySuccess = 0;
    let success = 0;
    const members = await this.memberRepository.find();

    for (const member of members) {
      const characterInventories = await this.characterInventoryRepository.find(
        {
          where: {
            member: {
              member_id: member.member_id,
            },
          },
          relations: ['character'],
        }
      );

      for (const characterInventory of characterInventories) {
        ++tasks;
        try {
          const exist = await this.collectionRepository.findOne({
            where: {
              member: { member_id: member.member_id },
              character: {
                character_id: characterInventory.character?.character_id,
              },
            },
          });
          if (exist) {
            ++alreadySuccess;
            continue;
          }
          const newCollection = this.collectionRepository.create({
            character: characterInventory.character,
            member: member,
          });
          await this.collectionRepository.save(newCollection);
          ++success;
        } catch (e) {
          console.error(
            'ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì—ëŸ¬: ',
            member.member_id,
            characterInventory.character_inventory_id,
            e
          );
        }
      }
    }

    console.log('ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ', success, '/', tasks);
    console.log('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°: ', alreadySuccess, '/', tasks);
    console.log(
      'ì´ ê²°ê³¼ (ë°ì´í„° ì¼ì¹˜): ',
      success + alreadySuccess,
      '/',
      tasks
    );
  }
}
```

## ë§ˆë¬´ë¦¬

ìƒë‹¹íˆ ê¸€ì´ ê¸¸ì–´ì ¸ì„œ ì—¬ê¸°ì—ì„œ ëŠê³  ë‹¤ìŒ í¬ìŠ¤íŒ…ì—ì„œ CI/CD, í…ŒìŠ¤íŠ¸, ë°°í¬ ë“±ì— ëŒ€í•´ ë‹¤ë£¨ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ë°±ì—”ë“œ ì´ì•¼ê¸°ë¡œ ì–´ë–¤ ì£¼ì œë¥¼ ì ì„ì§€ ê³ ë¯¼í•˜ë‹¤ê°€, ì‰¬ìš´ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ ê³ ë¯¼í•œ `DB`, `Env`, `Seed` êµ¬ì„±ì— ëŒ€í•´ ë‹¤ë¤„ë³´ì•˜ìŠµë‹ˆë‹¤.

í’€ìŠ¤íƒ ê°œë°œì„ í•˜ë‹¤ë³´ë©´ ì„œë²„ë¥¼ í•œë²ˆ ë°°í¬í•˜ê³  ì¶”ê°€ ê¸°ëŠ¥ì´ë‚˜ ë²„ê·¸ê°€ ìƒê¸°ì§€ ì•ŠëŠ” í•œ ê±´ë“œë¦¬ì§€ ì•Šê¸° ë•Œë¬¸ì— ì˜¤ëœë§Œì— ë´ë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ 5í¸ê³¼ 6í¸ì„ í†µí•´ `NestJS`ë¡œ ë°±ì—”ë“œë¥¼ ê°œë°œí•  ë•Œ ì‰¬ìš´ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•œ í† ëŒ€ë¥¼ ë‹¤ì§ˆ ìˆ˜ ìˆë„ë¡ í¬ìŠ¤íŒ…ì„ ì‘ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.
